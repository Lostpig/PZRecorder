@page "/daily-manager";

@using Services;
@using Data;

<MudPaper Width="100%" Height="100%" class="d-flex flex-column">
    <MudToolBar>
        <MudButton Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Add"
                   Color="Color.Primary"
                   Style="text-transform:none"
                   Class="mt-4"
                   OnClick="OnAddClick">@LD.Add</MudButton>
    </MudToolBar>
    <MudSimpleTable Hover="true" FixedHeader="true" Elevation="0" Style="height: calc(100% - 65px);">
        <thead>
            <tr>
                <th style="width: 90px;">ID</th>
                <th>@LD.Name</th>
                <th style="width: 90px;">@LD.OrderBy</th>
                <th style="width: 120px;">@LD.State</th>
                <th style="width: 320px;">@LD.Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var row in dailies)
            {
                Color stateColor = row.State == DailyState.Enabled ? Color.Success : Color.Error;
                <tr>
                    <td>@row.Id</td>
                    <td>
                        <MudText Typo="Typo.body1" Inline="true">@row.Name</MudText>
                        <MudText Typo="Typo.body2" Inline="true" Style="color: var(--mud-palette-text-secondary);">@row.Alias</MudText>
                    </td>
                    <td>@row.OrderNo</td>
                    <td>
                        <MudButton Variant="Variant.Text" Color="stateColor" OnClick="() => OnChangeState(row)">@row.StateText</MudButton>
                    </td>
                    <td>
                        <MudButton Variant="Variant.Text" Color="Color.Warning" OnClick="() => OnStatisticClick(row.Id)">@LD.Statistic</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => ShowDialog(row.Id)">@LD.Edit</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="() => OnDeleteClick(row.Id)">@LD.Delete</MudButton>
                    </td>
                </tr>
            }
        </tbody>
    </MudSimpleTable>
</MudPaper>


@code {
    [Inject] private IDialogService DialogService { get; set; } = default!;

    IList<Daily> dailies = new List<Daily>();

    protected override void OnInitialized()
    {
        dailies = DailyService.GetDailies(null);
    }

    private void UpdateList()
    {
        dailies = DailyService.GetDailies(null);
        StateHasChanged();
    }
    private async void OnDeleteClick(int id)
    {
        bool result = await DialogService.ShowConfirm(LD.SureToDelete);
        if (result == true)
        {
            try
            {
                DailyService.DeleteDaily(id);
                UpdateList();
            }
            catch (Exception ex)
            {
                await DialogService.ShowError(ex.Message);
            }
        }
    }
    private void OnAddClick()
    {
        ShowDialog(null);
    }
    private void OnStatisticClick(int id)
    {
        DialogParameters<Dialogs.DailyStatistics> paramters = new();
        paramters.Add(d => d.DailyId, id);

        DialogService.ShowAsync<Dialogs.DailyStatistics>(LD.CheckinStatistic, paramters);
    }

    private void OnChangeState(Daily item)
    {
        item.State = item.State == DailyState.Enabled ? DailyState.Disabled : DailyState.Enabled;
        DailyService.UpdateDaily(item);
    }

    private async void ShowDialog(int? id)
    {
        DialogParameters<Dialogs.DailyDialog> paramters = new();

        paramters.Add(d => d.IsEdit, id is not null);
        paramters.Add(d => d.DailyId, id ?? -1);
        string title = id is not null ? LD.Edit : LD.Add;

        var dialog = await DialogService.ShowAsync<Dialogs.DailyDialog>(title, paramters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            UpdateList();
        }
    }
}
