@using Services;
@using Data;

<MudDialog Style="width: 720px; height: 780px;">
    <DialogContent>
        <MudToolBar Class="mud-elevation-2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowLeft" OnClick="() => OnMonthChanged(-1)"></MudIconButton>
            <MudDatePicker Label="@LD.Month"
                           @bind-Date="setDate"
                           OpenTo="OpenTo.Year"
                           FixDay="1" DisableToolbar="true"
                           DateFormat="yyyy-MM" />
            <MudIconButton Icon="@Icons.Material.Filled.ArrowRight" OnClick="() => OnMonthChanged(1)"></MudIconButton>
        </MudToolBar>
        <MudDivider Class="my-2" />
        <MudText Typo="Typo.h5">@watch.Name</MudText>
        <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">@counterText</MudText>
        <MudDivider Class="my-2" />
        <MudTable Height="450px" Items="list" Hover="true" FixedHeader="true" Breakpoint="Breakpoint.Sm">
            <ColGroup>
                <col />
                <col style="width: 90px;" />
                <col style="width: 90px;" />
                <col style="width: 120px;" />
            </ColGroup>
            <HeaderContent>
                <MudTh>@LD.Date</MudTh>
                <MudTh>@LD.StartTime</MudTh>
                <MudTh>@LD.EndTime</MudTh>
                <MudTh Style="text-align: right;">@LD.Duration</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Date">@context.DateText</MudTd>
                <MudTd DataLabel="StartTime">@context.StartTimeText</MudTd>
                <MudTd DataLabel="EndTime">@context.EndTimeText</MudTd>
                <MudTd DataLabel="Duration" Style="text-align: right;">@context.DurationText</MudTd>
            </RowTemplate>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@LD.Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public int Id { get; set; }

    private ProcessWatch watch = default!;
    private List<ProcessRecord> list = new();
    private string counterText = "";
    private DateTime _setDate = DateTime.Today;
    private DateTime? setDate
    {
        get => _setDate;
        set {
            _setDate = value ?? DateTime.Today;
            OnDateChanged(_setDate);
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        watch = ProcessWatchService.GetWatch(Id);
        OnDateChanged(_setDate);
    }
    private void OnDateChanged(DateTime date)
    {
        var fd = new DateTime(date.Year, date.Month, 1);
        var ld = fd.AddMonths(1).AddDays(-1);
        var fdNum = DateOnly.FromDateTime(fd).DayNumber;
        var ldNum = DateOnly.FromDateTime(ld).DayNumber;

        list = ProcessWatchService.GetRecords(Id, fdNum, ldNum);
        TimeSpan totalTime = TimeSpan.FromSeconds(0);
        HashSet<int> days = new();

        foreach (var p in list) 
        {
            totalTime += p.Duration;
            days.Add(p.Date);
        }
        int hours = totalTime.Hours + totalTime.Days * 24;
        var totalTimeText = $"{hours}h {totalTime.Minutes:d2}m";
        var timePerDay = days.Count > 0 ? TimeSpan.FromSeconds(totalTime.TotalSeconds / days.Count) : TimeSpan.FromSeconds(0);
        var tpdHours = timePerDay.Hours + timePerDay.Days * 24;
        var timePerDayText = $"{tpdHours}h {timePerDay.Minutes:d2}m";

        counterText = string.Format(LD.RecordCount, list.Count, totalTimeText, days.Count, timePerDayText);
    }
    private void OnMonthChanged(int add)
    {
        setDate = _setDate.AddMonths(add);
    }

    void Cancel() => MudDialog.Cancel();
}
